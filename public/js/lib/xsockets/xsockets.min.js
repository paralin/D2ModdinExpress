this.XSockets={Version:"3.0",Events:{onError:"0x1f4",open:"0xc8",close:"0x12e0",storage:{set:"0x190",get:"0x191",getAll:"0x192",remove:"0x193"},onBlob:"0x12d0",connection:{onclientconnect:"0xc9",onclientdisconnect:"0xca",disconnect:"0xcb"},bindings:{completed:"0x12c0"},pubSub:{subscribe:"0x12c",unsubscribe:"0x12d"}},Utils:{longToByteArray:function(long){var byteArray=[0,0,0,0,0,0,0,0];for(var index=0;index<byteArray.length;index++){var byte=long&255;byteArray[index]=byte;long=(long-byte)/256}return byteArray},stringToBuffer:function(string){var i,len=string.length,arr=new Array(len);for(i=0;i<len;i++){arr[i]=string.charCodeAt(i)&255}return new Uint8Array(arr).buffer},parseUri:function(url){var uriParts={};var uri={port:80,relative:"/"};var keys=["url","scheme","host","domain","port","fullPath","path","relative","controller","query"],parser=/^(?:([^:\/?#]+):)?(?:\/\/(([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?)/;var result=url.match(parser);for(var i=0;i<keys.length;i++){uriParts[keys[i]]=result[i]}uriParts.rawQuery=uriParts.query||"";if(!uriParts.query){uriParts.query={}}else{var stack={};var arrQuery=uriParts.query.split("&");for(var q=0;q<arrQuery.length;q++){var keyValue=arrQuery[q].split("=");stack[keyValue[0]]=keyValue[1]}uriParts.query=stack}uriParts=XSockets.Utils.extend(uri,uriParts);uriParts.absoluteUrl=uriParts.scheme+"://"+uriParts.domain+":"+uriParts.port+uri.relative+uriParts.controller;return uriParts},randomString:function(x){var s="";while(s.length<x&&x>0){var r=Math.random();s+=String.fromCharCode(Math.floor(r*26)+(r>.5?97:65))}return s},getParameterByName:function(name){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regexS="[\\?&]"+name+"=([^&#]*)";var regex=new RegExp(regexS);var results=regex.exec(window.location.search);if(results==null)return"";else return decodeURIComponent(results[1].replace(/\+/g," "))},extend:function(obj,extObj){if(arguments.length>2){for(var a=1;a<arguments.length;a++){this.extend(obj,arguments[a])}}else{for(var i in extObj){obj[i]=extObj[i]}}return obj},guid:function(a,b){for(b=a="";a++<36;b+=a*51&52?(a^15?8^Math.random()*(a^20?16:4):4).toString(16):"-");return b}}};XSockets.Callback=function(){function Callback(name,func,opt){this.name=name;this.fn=func;this.state=opt;this.id=XSockets.Utils.guid()}return Callback}();XSockets.Subscription=function(){function Subscription(name){this.Name=name;this.Callbacks=[];this.addCallback=function(fn,opt){this.Callbacks.push(new XSockets.Callback(name,fn,opt))};this.removeCallback=function(ix){this.Callbacks.splice(ix,1)};this.fireCallback=function(message,cb,ix){this.Callbacks[ix].fn(message);if(typeof this.Callbacks[ix].state==="object"){if(typeof this.Callbacks[ix].state.options!=="undefined"&&typeof this.Callbacks[ix].state.options.counter!=="undefined"){this.Callbacks[ix].state.options.counter.messages--;if(this.Callbacks[ix].state.options.counter.messages===0){if(typeof this.Callbacks[ix].state.options.counter.completed==="function"){this.Callbacks[ix].state.options.counter.completed()}}}}};this.fireCallbacks=function(message,cb){for(var c=0;c<this.Callbacks.length;c++){this.fireCallback(message,cb,c)}}}return Subscription}();XSockets.Subscriptions=function(){function Subscriptions(){this.subscriptions=new Array;this.add=function(name,fn,opt){name=name.toLowerCase();var storedSub=this.get(name);if(storedSub===null){var sub=new XSockets.Subscription(name);sub.addCallback(fn,opt);this.subscriptions.push(sub);return 1}storedSub.addCallback(fn,opt);return storedSub.Callbacks.length};this.get=function(name){if(typeof name==="undefined")return;name=name.toLowerCase();for(var i=0;i<this.subscriptions.length;i++){if(this.subscriptions[i].Name===name){return this.subscriptions[i]}}return null};this.getAll=function(){return this.subscriptions};this.remove=function(name,ix){name=name.toLowerCase();for(var i=0;i<this.subscriptions.length;i++){if(this.subscriptions[i].Name===name){this.subscriptions[i].Callbacks.splice(ix,1);if(this.subscriptions[i].Callbacks.length===0)this.subscriptions.splice(i,1);return true}}return false};this.fire=function(name,message,cb,ix){if(typeof name==="undefined")return;name=name.toLowerCase();for(var i=0;i<this.subscriptions.length;i++){if(this.subscriptions[i].Name===name){if(ix===undefined){this.subscriptions[i].fireCallbacks(message,cb)}else{this.subscriptions[i].fireCallback(message,cb,ix)}}}}}return Subscriptions}();XSockets.Message=function(){function Message(event,object){this.event=event;this.data=object;this.JSON={event:event,data:JSON.stringify(object)}}Message.prototype.toString=function(){return JSON.stringify(this.JSON)};return Message}();XSockets.BinaryMessage=function(){BinaryMessage.prototype.stringToBuffer=function(str){var i,len=str.length,arr=new Array(len);for(i=0;i<len;i++){arr[i]=str.charCodeAt(i)&255}return new Uint8Array(arr).buffer};BinaryMessage.prototype.appendBuffer=function(a,b){var c=new Uint8Array(a.byteLength+b.byteLength);c.set(new Uint8Array(a),0);c.set(new Uint8Array(b),a.byteLength);return c.buffer};BinaryMessage.prototype.getHeader=function(){return this.header};function BinaryMessage(message,arrayBuffer,cb){if(!window.Uint8Array)throw"Unable to create a XSockets.BinaryMessage, the browser does not support Uint8Array";if(arguments.length===3){var payload=message.toString();this.id=new XSockets.Utils.guid;this.header=new Uint8Array(XSockets.Utils.longToByteArray(payload.length));this.buffer=this.appendBuffer(this.appendBuffer(this.header,this.stringToBuffer(payload)),arrayBuffer);if(cb)cb(this)}else if(arguments.length===2){var header=new Uint8Array(message,0,8);byteArrayToLong=function(byteArray){var value=0;for(var i=byteArray.byteLength-1;i>=0;i--){value=value*256+byteArray[i]}return value};var payloadLength=byteArrayToLong(header);var offset=8+byteArrayToLong(header);var buffer=new Uint8Array(message,offset,message.byteLength-offset);var payload=new Uint8Array(message,8,payloadLength);function ab2str(buf){return String.fromCharCode.apply(null,new Uint16Array(buf))}arrayBuffer(JSON.parse(ab2str(payload)),buffer)}}return BinaryMessage}();XSockets.WebSocket=function(){function WebSocket(url,subprotocol,settings){var self=this;this.id=XSockets.Utils.guid();this.subscriptions=new XSockets.Subscriptions;var parameters=function(p){var str="?";for(var key in p){str+=key+"="+encodeURIComponent(p[key])+"&"}str=str.slice(0,str.length-1);return str};this.dispatchEvent=function(eventName,message){if(self.subscriptions.get(eventName)===null){return}if(typeof message==="string"){try{message=JSON.parse(message)}catch(e){}}self.subscriptions.fire(eventName,message,function(evt){})};this.getClientType=function(){if(typeof window.WebSocket==="undefined")return"Fallback";return"WebSocket"in window&&window.WebSocket.CLOSED>2?"RFC6455":"Hixie"};this.options=XSockets.Utils.extend({parameters:{},binaryType:"arraybuffer"},typeof subprotocol==="object"&&!settings?subprotocol:settings);this.uri=XSockets.Utils.parseUri(url);if("WebSocket"in window&&window.WebSocket){if(this.getClientType()==="Fallback"){this.webSocket=new window.WebSocket(url,subprotocol)}else{var storageGuid=window.localStorage.getItem("XSocketsClientStorageGuid"+self.uri.controller)!==null?window.localStorage.getItem("XSocketsClientStorageGuid"+self.uri.controller):null;if(storageGuid!==null){self.uri.query.XSocketsClientStorageGuid=storageGuid}url=self.uri.absoluteUrl+parameters(XSockets.Utils.extend(this.options.parameters,self.uri.query));this.webSocket=new window.WebSocket(url,subprotocol||"XSocketsNET");this.webSocket.binaryType=this.options.binaryType}}if(this.webSocket!==null){this.bind(XSockets.Events.open,function(data){self.connection=XSockets.Utils.extend(data,{clientType:self.getClientType()});window.localStorage.setItem("XSocketsClientStorageGuid"+self.uri.controller,data.StorageGuid);var chain=self.subscriptions.getAll();for(var e=0;e<chain.length;e++){for(var c=0;c<chain[e].Callbacks.length;c++){if(chain[e].Callbacks[c].state.ready===0){if(chain[e].Callbacks[c].state.options)if(chain[e].Name,chain[e].Callbacks[c].state.options.hasOwnProperty("skip")){continue}self.trigger(new XSockets.Message(XSockets.Events.pubSub.subscribe,{Event:chain[e].Name,Confirm:chain[e].Callbacks[c].state.confirm}))}}}self.dispatchEvent(XSockets.Events.bindings.completed,self.subscriptions.getAll());if(typeof self.onopen==="function")self.onopen(data)},{skip:true});this.webSocket.onerror=function(err){if(self.onerror)self.onerror(err);self.dispatchEvent(XSockets.Events.onError,err)};this.webSocket.onclose=function(msg){if(self.onclose)self.onclose(msg);self.dispatchEvent("close",msg)};this.webSocket.onopen=function(msg){self.dispatchEvent("open",msg)};this.webSocket.onmessage=function(message){if(typeof message.data==="string"){var msg=JSON.parse(message.data);self.dispatchEvent(msg.event,msg.data);if(msg.event===XSockets.Events.onError){if(typeof self.onmessage==="function")self.onmessage(message);if(self.onerror)self.onerror(message.data,message);self.dispatchEvent(XSockets.Events.onError,JSON.parse(message.data))}}else{if(self.onblob)self.onblob(message.data);self.dispatchEvent(XSockets.Events.onBlob,message.data)}}}}WebSocket.prototype.readyState=function(){return this.webSocket.readyState};WebSocket.prototype.onblob=undefined;WebSocket.prototype.onopen=undefined;WebSocket.prototype.onclose=undefined;WebSocket.prototype.onmessage=undefined;WebSocket.prototype.onerror=undefined;WebSocket.prototype.removeCallback=function(from,ix){var sub=from.toLowerCase();return this.subscriptions.remove(sub,ix)};WebSocket.prototype.channel={};WebSocket.prototype.connection={};WebSocket.prototype.close=function(fn){this.trigger(XSockets.Events.connection.disconnect,{},fn)};WebSocket.prototype.getSubscriptions=function(){return this.subscriptions.subscriptions};WebSocket.prototype.bind=function(event,fn,opts,callback){var that=this;var o={options:!(opts instanceof Function)?opts:{},ready:this.webSocket.readyState,confirm:(callback||opts)instanceof Function};if(o.ready===1){this.trigger(new XSockets.Message(XSockets.Events.pubSub.subscribe,{Event:event,Confirm:o.confirm}))}if(fn instanceof Function){this.subscriptions.add(event,fn,o)}else if(fn instanceof Array){fn.forEach(function(cb){that.subscriptions.add(event,cb,o)})}if(typeof callback==="function"||typeof opts==="function")this.subscriptions.add("__"+event,callback||opts,{options:{ready:2}});return this};WebSocket.prototype.on=function(event,fn,opts,callback){return this.bind(event,fn,opts,callback)};WebSocket.prototype.subscribe=function(event,fn,opts,callback){return this.bind(event,fn,opts,callback)};WebSocket.prototype.many=function(event,count,fn,opts,callback){var that=this;this.bind(event,fn,XSockets.Utils.extend({counter:{messages:count,completed:function(){that.unbind(event)}}},opts),callback||opts);return this};WebSocket.prototype.one=function(event,fn,opts,callback){var that=this;this.bind(event,fn,XSockets.Utils.extend({counter:{messages:1,completed:function(){that.unbind(event)}}},opts),callback||opts);return this};WebSocket.prototype.unbind=function(event,callback){if(this.subscriptions.remove(event)){this.trigger(new XSockets.Message(XSockets.Events.pubSub.unsubscribe,{Event:event}))}if(callback&&typeof callback==="function"){callback()}return this};WebSocket.prototype.unsubscribe=function(event,callback){return this.unbind(event,callback)};WebSocket.prototype.off=function(event,callback){return this.unbind(event,callback)};WebSocket.prototype.trigger=function(event,json,callback){if(typeof event!=="object"){if(arguments.length!==2||typeof json!=="function"){if(arguments.length===1){json={}}}else{callback=json;json={}}}if(typeof event!=="object"){event=event.toLowerCase();var message=new XSockets.Message(event,json);this.webSocket.send(message.toString());if(callback&&typeof callback==="function"){callback()}}else{this.webSocket.send(event.toString());if(json&&typeof json==="function"){json()}}return this};WebSocket.prototype.publish=function(event,json,callback){return this.trigger(event,json,callback)};WebSocket.prototype.emit=function(event,json,callback){return this.trigger(event,json,callback)};WebSocket.prototype.send=function(payload){this.webSocket.send(payload);return this};WebSocket.prototype.triggerBinary=function(bytes){return this.send(bytes)};WebSocket.prototype.setProperty=function(name,value){var property="set_"+name;this.publish(property,typeof value==="object"?value:{value:value})};WebSocket.prototype.setEnum=function(name,value){var property="set_"+name;this.publish(property,value)};return WebSocket}();XSockets.Channel=function(){function Channel(){}Channel.prototype.create=function(url,handler,parameters,cb){var _channelUri=XSockets.Utils.parseUri(url);var id=XSockets.Utils.guid();var channelUrl=_channelUri.absoluteUrl+"/"+id;var channelWs=new XSockets.WebSocket(channelUrl,handler,XSockets.Utils.extend(_channelUri.query,parameters));channelWs.channel={Id:id,args:[channelUrl,handler,XSockets.Utils.extend(_channelUri.query,parameters)]};return channelWs};Channel.prototype.connect=function(channel){return new XSockets.WebSocket(channel.args[0],channel.args[1],channel.args[2])};return Channel}();